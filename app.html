<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BPGT Terminal System</title>

    <!-- ‚úÖ PWA - Makes app installable, removes Chrome bar when installed -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BPGT">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- ‚úÖ PWA Service Worker -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('service-worker.js')
            .then(() => console.log('‚úÖ BPGT PWA ready'))
            .catch(e => console.log('SW error:', e));
        });
      }
    </script>

    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <style>
        /* ====================================================
           RESET & BASE ‚Äî fixes the '''html''' background bug
           ==================================================== */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        html, body {
            width: 100%;
            min-height: 100%;
            background-color: #f1f5f9;  /* ‚úÖ PLAIN color, no text */
            font-family: 'Segoe UI', Arial, sans-serif;
            font-size: 15px;
            color: #1e293b;
            overflow-x: hidden;         /* ‚úÖ prevents horizontal scroll */
        }

        /* ====================================================
           HEADER
           ==================================================== */
        .app-header {
            background: linear-gradient(135deg, #1e3a8a, #1d4ed8);
            color: white;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .header-logo { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
        .header-title { font-size: 14px; font-weight: 700; line-height: 1.2; }
        .header-subtitle { font-size: 11px; opacity: 0.85; }
        .header-user { font-size: 12px; opacity: 0.9; text-align: right; }
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 4px;
        }

        /* ====================================================
           MAIN CONTENT AREA
           ==================================================== */
        .main-content {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
        }

        /* ====================================================
           FORM SECTIONS
           ==================================================== */
        .form-section {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        .section-title {
            font-size: 13px;
            font-weight: 700;
            color: #1e3a8a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 14px;
            padding-bottom: 8px;
            border-bottom: 2px solid #eff6ff;
        }

        /* ====================================================
           FORM INPUTS
           ==================================================== */
        .form-group { margin-bottom: 14px; }
        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1.5px solid #e2e8f0;
            border-radius: 8px;
            font-size: 15px;
            color: #1e293b;
            background: #f8fafc;
            transition: border-color 0.2s;
            -webkit-appearance: none;
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
        }
        .form-group select { cursor: pointer; }
        .form-group textarea { resize: vertical; min-height: 60px; }

        /* ====================================================
           PASSENGER COUNT GRID
           ==================================================== */
        .count-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .count-item { position: relative; }
        .count-total {
            background: #f0fdf4;
            border: 1.5px solid #059669;
            border-radius: 8px;
            padding: 10px 12px;
            font-weight: 700;
            color: #059669;
            text-align: center;
            font-size: 16px;
            margin-top: 10px;
        }

        /* ====================================================
           BUTTONS
           ==================================================== */
        .btn {
            width: 100%;
            padding: 13px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            letter-spacing: 0.3px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: #1e3a8a; color: white; }
        .btn-success { background: #059669; color: white; }
        .btn-blue    { background: #3b82f6; color: white; margin-bottom: 10px; }
        .btn-purple  { background: #7c3aed; color: white; margin-bottom: 10px; }
        .btn-orange  { background: #ea580c; color: white; }
        .btn-sm {
            width: auto;
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 8px;
            display: inline-block;
            margin-right: 8px;
            margin-top: 6px;
        }

        /* ====================================================
           FEE SECTION
           ==================================================== */
        .fee-section { display: none; }
        .fee-section.visible { display: block; }

        .fee-card {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border: 2px solid #059669;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            margin-bottom: 14px;
        }
        .fee-amount {
            font-size: 32px;
            font-weight: 800;
            color: #059669;
        }
        .fee-label { font-size: 12px; color: #64748b; margin-top: 2px; }

        /* ====================================================
           TICKET SECTION (V4.5)
           ==================================================== */
        .ticket-section { display: none; }
        .ticket-section.visible { display: block; }

        .ticket-header {
            background: #fef3c7;
            border: 1.5px solid #f59e0b;
            border-radius: 8px;
            padding: 10px 14px;
            margin-bottom: 14px;
            font-size: 13px;
            color: #92400e;
        }
        .ticket-denom-row {
            display: flex;
            gap: 10px;
            margin-bottom: 14px;
        }
        .ticket-denom-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            color: #475569;
        }
        .ticket-denom-btn.active {
            border-color: #1e3a8a;
            background: #eff6ff;
            color: #1e3a8a;
        }

        .ticket-field {
            background: #f8fafc;
            border: 1.5px solid #e2e8f0;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .ticket-field-label {
            font-size: 12px;
            font-weight: 700;
            color: #1e3a8a;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .ticket-input-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .ticket-input-row input {
            flex: 1;
            padding: 10px;
            border: 1.5px solid #e2e8f0;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            letter-spacing: 2px;
            font-family: 'Courier New', monospace;
            background: white;
        }
        .ticket-result {
            margin-top: 8px;
            font-size: 12px;
            color: #475569;
            background: white;
            border-radius: 6px;
            padding: 8px;
            border: 1px solid #e2e8f0;
            min-height: 24px;
        }
        .ticket-result.ok { background: #f0fdf4; border-color: #059669; color: #065f46; }
        .ticket-result.warn { background: #fef3c7; border-color: #f59e0b; color: #92400e; }

        .ticket-summary {
            background: #eff6ff;
            border: 2px solid #1e3a8a;
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
            font-size: 13px;
            color: #1e3a8a;
            display: none;
        }
        .ticket-summary.visible { display: block; }

        /* ====================================================
           CAMERA OVERLAY (full screen camera)
           ==================================================== */
        .camera-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: black;
            z-index: 9999;
            flex-direction: column;
        }
        .camera-overlay.visible { display: flex; }
        #camera-video { width: 100%; flex: 1; object-fit: cover; }
        .camera-controls {
            background: #1e293b;
            padding: 20px;
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        .snap-btn {
            background: white;
            border: none;
            border-radius: 50%;
            width: 70px; height: 70px;
            font-size: 28px;
            cursor: pointer;
        }
        .close-cam-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px; height: 50px;
            font-size: 20px;
            cursor: pointer;
        }

        /* ====================================================
           STATUS MESSAGES
           ==================================================== */
        .status-message {
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 14px;
            font-size: 14px;
            font-weight: 600;
            display: none;
        }
        .status-success { background: #d1fae5; color: #065f46; border: 1.5px solid #059669; }
        .status-error   { background: #fee2e2; color: #991b1b; border: 1.5px solid #ef4444; }

        /* ====================================================
           INFO BOXES
           ==================================================== */
        .info-box {
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 13px;
            margin-top: 8px;
        }
        .info-blue   { background: #eff6ff; border-left: 4px solid #3b82f6; color: #1e40af; }
        .info-green  { background: #f0fdf4; border-left: 4px solid #059669; color: #065f46; }
        .info-orange { background: #fff7ed; border-left: 4px solid #ea580c; color: #92400e; }
        .info-yellow { background: #fef3c7; border-left: 4px solid #f59e0b; color: #92400e; }
        .info-red    { background: #fee2e2; border-left: 4px solid #ef4444; color: #991b1b; }

        /* ====================================================
           VEHICLE STATUS & AUTO-FILL INDICATOR
           ==================================================== */
        #vehicle-status, #fee-warning { margin-top: 6px; }

        /* ====================================================
           HIDDEN UTILITY
           ==================================================== */
        .hidden { display: none !important; }

        /* ====================================================
           QR READER
           ==================================================== */
        #qr-reader {
            display: none;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        /* ====================================================
           PHOTO PREVIEW
           ==================================================== */
        #arkabala-preview img {
            width: 100%;
            border-radius: 10px;
            margin-top: 8px;
        }

        /* ====================================================
           RESPONSIVE SMALL SCREENS
           ==================================================== */
        @media (max-width: 360px) {
            .main-content { padding: 10px; }
            .fee-amount { font-size: 26px; }
        }
    </style>
</head>
<body>

<!-- ‚úÖ CAMERA OVERLAY (full screen, avoids gallery) -->
<div class="camera-overlay" id="camera-overlay">
    <video id="camera-video" autoplay playsinline></video>
    <div class="camera-controls">
        <button class="close-cam-btn" onclick="closeLiveCamera()">‚úï</button>
        <button class="snap-btn" onclick="snapPhoto()">üì∏</button>
    </div>
</div>

<!-- ‚úÖ APP HEADER -->
<div class="app-header">
    <div class="header-left">
        <img src="bpgt-logo.png" alt="BPGT" class="header-logo" onerror="this.style.display='none'">
        <div>
            <div class="header-title">üöå BPGT Terminal</div>
            <div class="header-subtitle">Passenger & Revenue System</div>
        </div>
    </div>
    <div style="text-align:right;">
        <div class="header-user" id="user-name">Loading...</div>
        <button class="logout-btn" onclick="logout()">‚¨Ö Logout</button>
    </div>
</div>

<!-- ‚úÖ MAIN CONTENT -->
<div class="main-content">

    <!-- STATUS MESSAGE -->
    <div class="status-message" id="status-message"></div>

    <form id="passenger-form">

        <!-- ‚îÄ‚îÄ SECTION 1: VEHICLE ‚îÄ‚îÄ -->
        <div class="form-section">
            <div class="section-title">üöó Vehicle Information</div>

            <div class="form-group">
                <label>Plate Number</label>
                <input type="text" id="plate-number" placeholder="e.g. AAD 5514"
                       autocomplete="off" autocapitalize="characters" required>
                <div id="vehicle-status"></div>
            </div>

            <button type="button" class="btn btn-blue" onclick="startQRScanner()">
                üì∑ Scan QR Code (Plate Number)
            </button>
            <div id="qr-reader"></div>

            <div class="form-group">
                <label>Vehicle Type</label>
                <select id="denomination" required>
                    <option value="">Select Vehicle Type</option>
                    <option>BUS</option>
                    <option>SHUTTLE VAN</option>
                    <option>JEEP</option>
                    <option>MULTICAB</option>
                    <option>FILCAB</option>
                    <option>TRICYCLE</option>
                </select>
            </div>

            <div class="form-group">
                <label>Transport Group</label>
                <select id="transport-group" disabled required>
                    <option value="">First select vehicle type</option>
                </select>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ SECTION 2: TRIP ‚îÄ‚îÄ -->
        <div class="form-section">
            <div class="section-title">üìã Trip Details</div>

            <div class="count-grid">
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="trip-date" required>
                </div>
                <div class="form-group">
                    <label>Time</label>
                    <input type="time" id="trip-time" required>
                </div>
            </div>

            <div class="form-group">
                <label>Arrival or Departure?</label>
                <select id="type" required>
                    <option value="">Select Type</option>
                    <option value="ARRIVAL">üü¢ ARRIVAL ‚Äî Coming IN</option>
                    <option value="DEPARTURE">üî¥ DEPARTURE ‚Äî Going OUT</option>
                </select>
            </div>

            <!-- Origin (for Arrivals) -->
            <div class="form-group hidden" id="origin-group">
                <label>Coming From (Origin)</label>
                <select id="origin">
                    <option value="">Select Origin</option>
                </select>
            </div>

            <!-- Destination (for Departures) -->
            <div class="form-group hidden" id="destination-group">
                <label>Going To (Destination)</label>
                <select id="destination">
                    <option value="">Select Destination</option>
                </select>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ SECTION 3: PASSENGERS ‚îÄ‚îÄ -->
        <div class="form-section">
            <div class="section-title">üë• Passenger Count</div>

            <div class="count-grid">
                <div class="form-group">
                    <label>Adult Male</label>
                    <input type="number" id="adult-male" class="passenger-count" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>Adult Female</label>
                    <input type="number" id="adult-female" class="passenger-count" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>Child Male</label>
                    <input type="number" id="child-male" class="passenger-count" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>Child Female</label>
                    <input type="number" id="child-female" class="passenger-count" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>Senior Male</label>
                    <input type="number" id="senior-male" class="passenger-count" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>Senior Female</label>
                    <input type="number" id="senior-female" class="passenger-count" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>PWD Male</label>
                    <input type="number" id="pwd-male" class="passenger-count" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>PWD Female</label>
                    <input type="number" id="pwd-female" class="passenger-count" min="0" value="0">
                </div>
            </div>

            <div class="form-group">
                <label>Pregnant Women</label>
                <input type="number" id="pregnant" class="passenger-count" min="0" value="0">
            </div>

            <input type="hidden" id="adult-total">
            <input type="hidden" id="child-total">

            <div class="count-total" id="total-passengers">Total Passengers: 0</div>
        </div>

        <!-- ‚îÄ‚îÄ SECTION 4: TERMINAL FEE ‚îÄ‚îÄ -->
        <div class="form-section fee-section" id="fee-section">
            <div class="section-title">üí∞ Terminal Fee</div>

            <div id="fee-warning"></div>

            <div class="fee-card">
                <div class="fee-amount" id="fee-amount-display">‚Ç±0.00</div>
                <div class="fee-label">Terminal Fee ‚Äî Departure Only</div>
            </div>
            <input type="hidden" id="terminal-fee-amount" value="0">

            <div class="form-group">
                <label>Payment Method</label>
                <select id="payment-method">
                    <option value="">Select Method</option>
                    <option value="Cash">üíµ Cash</option>
                    <option value="GCash">üì± GCash</option>
                    <option value="Maya">üì± Maya</option>
                    <option value="Bank Transfer">üè¶ Bank Transfer</option>
                </select>
            </div>

            <div class="form-group">
                <label>Payment Status</label>
                <select id="payment-status">
                    <option value="">Select Status</option>
                    <option value="Paid">‚úÖ Paid</option>
                    <option value="Unpaid">‚ùå Unpaid / Will pay later</option>
                    <option value="Waived">‚ö™ Waived (Special case)</option>
                </select>
            </div>

            <div class="form-group">
                <label>Receipt Number (auto-generated)</label>
                <input type="text" id="receipt-number" placeholder="TF-2026-XXXX (auto)">
            </div>

            <div class="form-group">
                <label>Notes</label>
                <textarea id="fee-notes" placeholder="Optional notes..."></textarea>
            </div>

            <!-- ‚îÄ‚îÄ TICKET SECTION (V4.5) ‚îÄ‚îÄ -->
            <div class="ticket-section" id="ticket-section">
                <div class="section-title" style="margin-top:4px;">üé´ Cash Ticket (Arkabala) Serial Numbers</div>

                <div class="ticket-header" id="ticket-denomination-hint">
                    Loading fee info...
                </div>

                <!-- ‚Ç±10 TICKET FIELD -->
                <div class="ticket-field" id="field-10">
                    <div class="ticket-field-label">
                        <span style="background:#1e3a8a;color:white;padding:2px 8px;border-radius:4px;font-size:12px;">‚Ç±10</span>
                        Ticket ‚Äî Enter FIRST serial number:
                    </div>
                    <div class="ticket-input-row">
                        <input type="number" id="serial-start-10" placeholder="000001"
                               min="1" oninput="recalculateTickets()" style="font-family:monospace;">
                        <button type="button" class="btn btn-blue btn-sm"
                                onclick="readSerialWithOCR('10')" style="white-space:nowrap;">üîç Scan</button>
                    </div>
                    <div class="ticket-result" id="result-10"></div>
                </div>

                <!-- ‚Ç±5 TICKET FIELD -->
                <div class="ticket-field" id="field-5">
                    <div class="ticket-field-label">
                        <span style="background:#7c3aed;color:white;padding:2px 8px;border-radius:4px;font-size:12px;">‚Ç±5</span>
                        Ticket ‚Äî Enter FIRST serial number:
                    </div>
                    <div class="ticket-input-row">
                        <input type="number" id="serial-start-5" placeholder="000001"
                               min="1" oninput="recalculateTickets()" style="font-family:monospace;">
                        <button type="button" class="btn btn-blue btn-sm"
                                onclick="readSerialWithOCR('5')" style="white-space:nowrap;">üîç Scan</button>
                    </div>
                    <div class="ticket-result" id="result-5"></div>
                </div>

                <!-- TICKET SUMMARY -->
                <div class="ticket-summary" id="ticket-summary"></div>
                <input type="hidden" id="ticket-record-10">
                <input type="hidden" id="ticket-record-5">

            </div><!-- end ticket-section -->

            <!-- Arkabala Photo -->
            <div style="margin-top:14px;">
                <button type="button" class="btn btn-purple" onclick="captureArkabalaPhoto()">
                    üì∏ Capture Arkabala Photo (with GPS)
                </button>
                <div id="arkabala-preview"></div>
            </div>

        </div><!-- end fee-section -->

        <!-- ‚îÄ‚îÄ SUBMIT ‚îÄ‚îÄ -->
        <button type="submit" class="btn btn-success" id="submit-btn" style="margin-bottom:24px;">
            üì§ SUBMIT DATA
        </button>

    </form>
</div><!-- end main-content -->

<!-- Scripts -->
<script src="auth.js"></script>
<script src="config.js"></script>
<script src="app-logic.js"></script>

</body>
</html>
